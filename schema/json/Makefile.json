# Ugly hack to grab the correct path of the typescript-json-schema "binary"
# Taken from: http://blog.jgc.org/2007/01/what-makefile-am-i-in.html
where-am-i = $(dir $(CURDIR)/$(word $(words $(MAKEFILE_LIST)),$(MAKEFILE_LIST)))

# Path to the clients source and its project file
SRC_PATH = $(realpath ../../client/app/shared)
SRC_PROJECT = $(realpath ../../client/tsconfig.json)

# The absolute path of the directory the schemas reside in
SCHEMA_PATH = $(realpath $(call where-am-i))

# Full path of typescript-json-schema
TYPESCRIPT_JSON_SCHEMA_BIN = $(SCHEMA_PATH)/node_modules/typescript-json-schema/bin/typescript-json-schema

# Names of the schema files to generate
JSON_SCHEMA_FILE_NAMES = ProjectDescription.json ProjectListDescription.json QueryResultDescription.json QueryParamsDescription.json ArbitraryQueryRequestDescription.json QueryUpdateRequestDescription.json QueryDescription.json QueryRunErrorDescription.json

# Paths of the schema files to generate
JSON_SCHEMA_FILES = $(addprefix $(SCHEMA_PATH)/, $(JSON_SCHEMA_FILE_NAMES))

##################################
# Not so nice: Repeated rules
##################################
$(SCHEMA_PATH)/ProjectDescription.json : $(SRC_PATH)/project.description.ts
	$(TYPESCRIPT_JSON_SCHEMA_BIN) $(SRC_PROJECT) $(notdir $(basename $@)) --out $@

$(SCHEMA_PATH)/ProjectListDescription.json : $(SRC_PATH)/project.description.ts
	$(TYPESCRIPT_JSON_SCHEMA_BIN) $(SRC_PROJECT) $(notdir $(basename $@)) --out $@	

$(SCHEMA_PATH)/QueryDescription.json : $(SRC_PATH)/query.model.ts
	$(TYPESCRIPT_JSON_SCHEMA_BIN) $(SRC_PROJECT) $(notdir $(basename $@)) --out $@	

$(SCHEMA_PATH)/QueryUpdateRequestDescription.json : $(SRC_PATH)/query.ts
	$(TYPESCRIPT_JSON_SCHEMA_BIN) $(SRC_PROJECT) $(notdir $(basename $@)) --out $@

$(SCHEMA_PATH)/QueryResultDescription.json : $(SRC_PATH)/query.result.ts
	$(TYPESCRIPT_JSON_SCHEMA_BIN) $(SRC_PROJECT) $(notdir $(basename $@)) --out $@

$(SCHEMA_PATH)/QueryRunErrorDescription.json : $(SRC_PATH)/query.result.ts
	$(TYPESCRIPT_JSON_SCHEMA_BIN) $(SRC_PROJECT) $(notdir $(basename $@)) --out $@

$(SCHEMA_PATH)/QueryParamsDescription.json : $(SRC_PATH)/query.result.ts
	$(TYPESCRIPT_JSON_SCHEMA_BIN) $(SRC_PROJECT) $(notdir $(basename $@)) --out $@

$(SCHEMA_PATH)/ArbitraryQueryRequestDescription.json : $(SRC_PATH)/query.result.ts
	$(TYPESCRIPT_JSON_SCHEMA_BIN) $(SRC_PROJECT) $(notdir $(basename $@)) --out $@

# Ensure the typescript-json-schema "binary" is part of the node_modules folder
has-generator :
ifeq (, $(wildcard $(TYPESCRIPT_JSON_SCHEMA_BIN)))
	$(error "Typescript JSON schema generator not in node_modules")
endif

.PHONY :

